name: Flask CI/CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        
    - name: Install Python dependencies
      run: |
        pip3 install --upgrade pip
        pip3 install flask gunicorn requests Pillow numpy matplotlib
    
    - name: Prepare test environment
      run: |
        echo "Создаём необходимые директории..."
        mkdir -p flaskapp/static/uploads
        mkdir -p flaskapp/static/results
        mkdir -p flaskapp/templates
        
        echo "Проверяем структуру проекта..."
        find . -type f -name "*.py" | head -10
        echo "---"
        ls -la flaskapp/
    
    - name: Make test script executable
      run: chmod +x flaskapp/run_test.sh
    
    - name: Run CI tests
      timeout-minutes: 5
      run: |
        echo "Запускаем интеграционные тесты..."
        cd flaskapp
        ./run_test.sh
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v2
      with:
        name: ci-failure-logs
        path: |
          /tmp/gunicorn.log
          /tmp/gunicorn-error.log
        retention-days: 1
