name: Flask CI/CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask==2.3.3
        pip install gunicorn==21.2.0
        pip install requests==2.31.0
        pip install Pillow==10.1.0
        pip install numpy==1.24.3
        pip install matplotlib==3.7.3
        pip install Werkzeug==2.3.7
        echo "Dependencies installed successfully!"
    
    - name: Check Python installation
      run: |
        python --version
        pip list
    
    - name: Make scripts executable
      run: |
        chmod +x flaskapp/run_test.sh
        echo "Script permissions set"
    
    - name: Create necessary directories
      run: |
        mkdir -p flaskapp/static/uploads
        mkdir -p flaskapp/static/results
        mkdir -p flaskapp/templates
        echo "Directory structure:"
        ls -la flaskapp/
        echo "---"
        ls -la flaskapp/static/
    
    - name: Check templates
      run: |
        echo "Checking templates..."
        if [ -f "flaskapp/templates/simple.html" ]; then
          echo "✓ simple.html exists"
          head -5 flaskapp/templates/simple.html
        else
          echo "✗ simple.html missing!"
        fi
    
    - name: Run tests
      run: |
        echo "=== Starting test execution ==="
        cd flaskapp
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        
        # Даём немного времени перед запуском
        sleep 2
        
        # Запускаем тесты с таймаутом
        timeout 120 ./run_test.sh
        
    - name: Upload test artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v2
      with:
        name: test-logs
        path: |
          flaskapp/
          .github/workflows/
